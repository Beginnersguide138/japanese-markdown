<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JAMdown Pad - Japanese Markdown Editor with full-width character support">
    <title>JAMdown Pad - Japanese Markdown Editor</title>

    <!-- Marked.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>

    <style>
        /* CSS Variables for theming */
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #fff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --text-accent: #2c3e50;
            --border-color: #e9ecef;
            --border-light: #dee2e6;
            --accent-color: #007bff;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --success-text: #155724;
            --code-bg: #f8f9fa;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --text-accent: #f8f9fa;
            --border-color: #495057;
            --border-light: #6c757d;
            --accent-color: #4dabf7;
            --success-bg: #155724;
            --success-border: #28a745;
            --success-text: #d4edda;
            --code-bg: #3a3a3a;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        header h1 {
            color: var(--text-accent);
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            color: var(--text-accent);
            background-color: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .github-link {
            color: var(--text-secondary);
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .github-link:hover {
            color: var(--text-accent);
            background-color: var(--bg-tertiary);
        }

        /* Main container */
        .app-container {
            display: flex;
            height: calc(100vh - 140px);
            gap: 1px;
            background-color: var(--border-color);
        }

        /* Editor section */
        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .editor-header {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h2 {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .editor-controls {
            display: flex;
            gap: 0.5rem;
        }

        #editor {
            flex: 1;
            border: none;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        #editor::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Preview section */
        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .preview-header {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h2 {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .preview-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .download-group {
            display: flex;
            gap: 0.25rem;
        }

        .download-group button {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .preview-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        /* Button styles */
        button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        button:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
        }

        button:active {
            background: var(--border-color);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Preview content styling */
        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-accent);
        }

        .preview-content h1 {
            font-size: 2rem;
        }

        .preview-content h2 {
            font-size: 1.5rem;
        }

        .preview-content h3 {
            font-size: 1.25rem;
        }

        .preview-content h4 {
            font-size: 1.1rem;
        }

        .preview-content h5 {
            font-size: 1rem;
        }

        .preview-content h6 {
            font-size: 0.9rem;
        }

        .preview-content p {
            margin-bottom: 1rem;
        }

        .preview-content ul,
        .preview-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .preview-content li {
            margin-bottom: 0.25rem;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--border-light);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .preview-content code {
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .preview-content pre {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .preview-content pre code {
            background: none;
            padding: 0;
        }

        .preview-content hr {
            border: none;
            border-top: 1px solid var(--border-light);
            margin: 2rem 0;
        }

        .preview-content a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .preview-content a:hover {
            text-decoration: underline;
        }

        /* Table styling */
        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .preview-content th,
        .preview-content td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-light);
        }

        .preview-content tr:hover {
            background: var(--bg-tertiary);
        }

        .preview-content tr:last-child td {
            border-bottom: none;
        }

        /* Table alignment classes */
        .preview-content th[align="center"],
        .preview-content td[align="center"] {
            text-align: center;
        }

        .preview-content th[align="right"],
        .preview-content td[align="right"] {
            text-align: right;
        }

        .preview-content th[align="left"],
        .preview-content td[align="left"] {
            text-align: left;
        }

        /* Task list styling */
        .preview-content input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.1);
        }

        .preview-content li:has(input[type="checkbox"]) {
            list-style: none;
            margin-left: -1.5rem;
        }

        /* Strikethrough styling */
        .preview-content del {
            color: #6c757d;
            text-decoration-thickness: 2px;
        }

        /* Responsive table */
        @media (max-width: 768px) {
            .preview-content table {
                font-size: 0.875rem;
            }

            .preview-content th,
            .preview-content td {
                padding: 0.5rem 0.75rem;
            }
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .footer-links {
            margin-top: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .footer-links a:hover {
            background-color: var(--bg-tertiary);
            text-decoration: none;
        }

        .footer-links span {
            color: var(--border-light);
            font-size: 0.8rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 140px);
            }

            .editor-section,
            .preview-section {
                min-height: 300px;
            }

            header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .editor-header,
            .preview-header {
                padding: 0.75rem;
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .editor-controls,
            .preview-controls {
                justify-content: center;
            }

            #editor {
                padding: 0.75rem;
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            .preview-content {
                padding: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 0.75rem;
            }

            .header-content {
                gap: 0.75rem;
            }

            header h1 {
                font-size: 1.25rem;
            }

            .editor-controls,
            .preview-controls {
                flex-direction: column;
            }

            .download-group {
                flex-direction: column;
                width: 100%;
            }

            .download-group button {
                font-size: 0.9rem;
                padding: 0.6rem;
            }

            button {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="header-text">
                <h1>JAMdown Pad</h1>
                <p>Japanese Markdown Editor - Êó•Êú¨Ë™ûË®òÊ≥ïÂØæÂøú„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Ç®„Éá„Ç£„Çø</p>
            </div>
            <div class="header-controls">
                <button id="theme-toggle" class="theme-toggle" title="„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà">
                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                </button>
                <a href="https://github.com/Beginnersguide138/japanese-markdown" target="_blank" rel="noopener"
                    class="github-link" title="GitHub„É™„Éù„Ç∏„Éà„É™"></a>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
                </a>
            </div>
        </div>
    </header>

    <main class="app-container">
        <!-- Two-pane layout -->
        <div class="editor-section">
            <div class="editor-header">
                <h2>„Ç®„Éá„Ç£„Çø</h2>
                <div class="editor-controls">
                    <input type="file" id="file-input" accept=".md,.jamd,.jmd,.txt" style="display: none;">
                    <button id="upload-btn" type="button">„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</button>
                </div>
            </div>
            <textarea id="editor" placeholder="Êó•Êú¨Ë™û„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...
‰æãÔºö
ÔºÉ Ë¶ãÂá∫„Åó
ÔºäÔºäÂ§™Â≠óÔºäÔºä
ÔºäÊñú‰ΩìÔºä
Ôºû ÂºïÁî®
„Éª „É™„Çπ„ÉàÈ†ÖÁõÆ
ÔºëÔºé Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà
ÔΩúÂàóÔºëÔΩúÂàóÔºíÔΩú
ÔΩúÔºö„ÉºÔΩúÔºö„ÉºÔºöÔΩú
ÔΩú„Éá„Éº„ÇøÔºëÔΩú„Éá„Éº„ÇøÔºíÔΩú
ÔΩÄ„Ç≥„Éº„ÉâÔΩÄ
„Äú„ÄúÂèñ„ÇäÊ∂à„Åó„Äú„Äú
‚ñ° „Çø„Çπ„ÇØ
‚òë ÂÆå‰∫Ü"></textarea>
        </div>

        <div class="preview-section">
            <div class="preview-header">
                <h2>„Éó„É¨„Éì„É•„Éº</h2>
                <div class="preview-controls">
                    <div class="download-group">
                        <button id="download-md-btn" type="button">.md‰øùÂ≠ò</button>
                        <button id="download-jamd-btn" type="button">.jamd‰øùÂ≠ò</button>
                        <button id="download-jmd-btn" type="button">.jmd‰øùÂ≠ò</button>
                    </div>
                    <button id="copy-html-btn" type="button">HTML„Ç≥„Éî„Éº</button>
                </div>
            </div>
            <div id="preview" class="preview-content"></div>
        </div>
    </main>

    <footer>
        <p>JAMdown Pad - „Ç∑„Éº„É†„É¨„Çπ„Å™Êó•Êú¨Ë™û„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Á∑®ÈõÜ</p>
        <div class="footer-links">
            <a href="https://github.com/Beginnersguide138/japanese-markdown/blob/main/README.md" target="_blank"
                rel="noopener">üìñ README</a>
            <span>|</span>
            <a href="https://github.com/Beginnersguide138/japanese-markdown/blob/main/LICENSE" target="_blank"
                rel="noopener">üìÑ LICENSE</a>
            <span>|</span>
            <a href="https://github.com/Beginnersguide138/japanese-markdown" target="_blank" rel="noopener">üêô
                GitHub</a>
        </div>
    </footer>

    <script>
        // Normalization Engine - Core conversion logic for Japanese to standard Markdown
        class NormalizationEngine {
            // Helper function to convert full-width numbers to half-width
            static convertFullWidthNumber(fullWidthNum) {
                const fullWidthNumbers = 'ÔºêÔºëÔºíÔºìÔºîÔºïÔºñÔºóÔºòÔºô';
                const halfWidthNumbers = '0123456789';
                let result = '';
                for (let char of fullWidthNum) {
                    const index = fullWidthNumbers.indexOf(char);
                    result += index !== -1 ? halfWidthNumbers[index] : char;
                }
                return result;
            }

            // Get all conversion rules as a Map
            static getConversionRules() {
                return new Map([
                    // Headings: ÔºÉ to #
                    [/^(ÔºÉ{1,6})\s*/gm, (match, hashes) => '#'.repeat(hashes.length) + ' '],

                    // Bold: ÔºäÔºätextÔºäÔºä to **text**
                    [/ÔºäÔºä([^Ôºä]+?)ÔºäÔºä/g, '**$1**'],

                    // Italic: ÔºätextÔºä to *text* (but not if it's part of bold)
                    [/(?<!\*)Ôºä([^Ôºä]+?)Ôºä(?!\*)/g, '*$1*'],

                    // Blockquotes: Ôºû to >
                    [/^Ôºû\s*/gm, '> '],

                    // Links: „Äålink name„ÄçÔºàURLÔºâ to [link name](URL)
                    [/„Äå([^„Äç]+)„ÄçÔºà([^Ôºâ]+)Ôºâ/g, '[$1]($2)'],

                    // Code blocks: ÔΩÄÔΩÄÔΩÄ to ```
                    [/ÔΩÄÔΩÄÔΩÄ/g, '```'],

                    // Horizontal rules: ÔºäÔºäÔºä to ***
                    [/^ÔºäÔºäÔºä\s*$/gm, '***'],

                    // Horizontal rules: „Éº„Éº„Éº to ---
                    [/^„Éº„Éº„Éº\s*$/gm, '---'],

                    // Bullet lists: „Éª to *
                    [/^„Éª\s*/gm, '* '],

                    // Numbered lists: ÔºëÔºé to 1. (with full-width number conversion)
                    [/^([Ôºê-Ôºô]+)Ôºé\s*/gm, (match, num) => {
                        return NormalizationEngine.convertFullWidthNumber(num) + '. ';
                    }],

                    // Table support: ÔΩú to |
                    [/ÔΩú/g, '|'],

                    // Table alignment: Ôºö„Éº to :- and Ôºö„ÉºÔºö to :-:
                    [/Ôºö„ÉºÔºö/g, ':-:'],
                    [/Ôºö„Éº/g, ':-'],
                    [/„ÉºÔºö/g, '-:'],

                    // Inline code: ÔΩÄcodeÔΩÄ to `code`
                    [/ÔΩÄ([^ÔΩÄ]+?)ÔΩÄ/g, '`$1`'],

                    // Strikethrough: „Äú„Äútext„Äú„Äú to ~~text~~
                    [/„Äú„Äú([^„Äú]+?)„Äú„Äú/g, '~~$1~~'],

                    // Task lists: ‚ñ° and ‚òë to - [ ] and - [x]
                    [/^‚ñ°\s*/gm, '- [ ] '],
                    [/^‚òë\s*/gm, '- [x] '],

                    // Images: ÔºÅ„Äåalt text„ÄçÔºàURLÔºâ to ![alt text](URL)
                    [/ÔºÅ„Äå([^„Äç]+)„ÄçÔºà([^Ôºâ]+)Ôºâ/g, '![$1]($2)'],

                    // Footnotes: ÔºªÔºænumberÔºΩ to [^number]
                    [/ÔºªÔºæ([Ôºê-Ôºô]+)ÔºΩ/g, (match, num) => {
                        return '[^' + NormalizationEngine.convertFullWidthNumber(num) + ']';
                    }],

                    // Additional common full-width symbols
                    [/Ôºö/g, ':'],
                    [/Ôºõ/g, ';'],
                    [/Ôºå/g, ','],
                    [/Ôºé/g, '.'],
                    [/Ôºü/g, '?'],
                    [/ÔºÅ/g, '!'],
                    [/Ôºà/g, '('],
                    [/Ôºâ/g, ')'],
                    [/Ôºª/g, '['],
                    [/ÔºΩ/g, ']'],
                    [/ÔΩõ/g, '{'],
                    [/ÔΩù/g, '}'],
                ]);
            }

            // Main normalization method
            static normalize(text) {
                if (!text || typeof text !== 'string') {
                    return '';
                }

                let normalizedText = text;
                const rules = this.getConversionRules();

                // Apply each conversion rule
                for (let [pattern, replacement] of rules) {
                    normalizedText = normalizedText.replace(pattern, replacement);
                }

                return normalizedText;
            }

            // Test method to verify conversions
            static test() {
                const testCases = [
                    { input: 'ÔºÉ Ë¶ãÂá∫„ÅóÔºë', expected: '# Ë¶ãÂá∫„ÅóÔºë' },
                    { input: 'ÔºÉÔºÉ Ë¶ãÂá∫„ÅóÔºí', expected: '## Ë¶ãÂá∫„ÅóÔºí' },
                    { input: 'ÔºäÔºäÂ§™Â≠óÔºäÔºä', expected: '**Â§™Â≠ó**' },
                    { input: 'ÔºäÊñú‰ΩìÔºä', expected: '*Êñú‰Ωì*' },
                    { input: 'Ôºû ÂºïÁî®Êñá', expected: '> ÂºïÁî®Êñá' },
                    { input: '„Äå„É™„É≥„ÇØ„ÄçÔºàhttps://example.comÔºâ', expected: '[„É™„É≥„ÇØ](https://example.com)' },
                    { input: 'ÔΩÄÔΩÄÔΩÄjavascript', expected: '```javascript' },
                    { input: 'ÔºäÔºäÔºä', expected: '***' },
                    { input: '„Éº„Éº„Éº', expected: '---' },
                    { input: '„Éª „É™„Çπ„ÉàÈ†ÖÁõÆ', expected: '* „É™„Çπ„ÉàÈ†ÖÁõÆ' },
                    { input: 'ÔºëÔºé Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà', expected: '1. Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà' },
                    { input: 'ÔΩúÂàóÔºëÔΩúÂàóÔºíÔΩú', expected: '|ÂàóÔºë|ÂàóÔºí|' },
                    { input: 'ÔΩúÔºö„ÉºÔΩúÔºö„ÉºÔºöÔΩú', expected: '|:-|:-:|' },
                    { input: 'ÔΩú„Éá„Éº„ÇøÔºëÔΩú„Éá„Éº„ÇøÔºíÔΩú', expected: '|„Éá„Éº„ÇøÔºë|„Éá„Éº„ÇøÔºí|' },
                    { input: 'ÔΩÄ„Ç≥„Éº„ÉâÔΩÄ', expected: '`„Ç≥„Éº„Éâ`' },
                    { input: '„Äú„ÄúÂèñ„ÇäÊ∂à„Åó„Äú„Äú', expected: '~~Âèñ„ÇäÊ∂à„Åó~~' },
                    { input: '‚ñ° Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ', expected: '- [ ] Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ' },
                    { input: '‚òë ÂÆå‰∫Ü„Çø„Çπ„ÇØ', expected: '- [x] ÂÆå‰∫Ü„Çø„Çπ„ÇØ' },
                    { input: 'ÔºÅ„ÄåÁîªÂÉèË™¨Êòé„ÄçÔºàimage.jpgÔºâ', expected: '![ÁîªÂÉèË™¨Êòé](image.jpg)' },
                    { input: 'ÔºªÔºæÔºëÔºΩ', expected: '[^1]' },
                ];

                console.log('Testing NormalizationEngine...');
                let passed = 0;
                let failed = 0;

                testCases.forEach((testCase, index) => {
                    const result = this.normalize(testCase.input);
                    if (result === testCase.expected) {
                        console.log(`‚úì Test ${index + 1} passed: "${testCase.input}" ‚Üí "${result}"`);
                        passed++;
                    } else {
                        console.error(`‚úó Test ${index + 1} failed: "${testCase.input}" ‚Üí "${result}" (expected: "${testCase.expected}")`);
                        failed++;
                    }
                });

                console.log(`Test results: ${passed} passed, ${failed} failed`);
                return failed === 0;
            }
        }

        // Editor Controller - Manages textarea input and real-time updates
        class EditorController {
            constructor(textareaElement) {
                this.textarea = textareaElement;
                this.callbacks = [];
                this.debounceTimer = null;
                this.debounceDelay = 150; // 150ms debounce for optimal performance

                this.setupEventListeners();
            }

            setupEventListeners() {
                // Input event with debouncing
                this.textarea.addEventListener('input', (event) => {
                    this.handleInput();
                });

                // Handle paste events
                this.textarea.addEventListener('paste', (event) => {
                    // Small delay to allow paste content to be processed
                    setTimeout(() => this.handleInput(), 10);
                });

                // Handle keyboard shortcuts
                this.textarea.addEventListener('keydown', (event) => {
                    this.handleKeydown(event);
                });
            }

            handleInput() {
                // Clear existing timer
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }

                // Set new timer
                this.debounceTimer = setTimeout(() => {
                    const text = this.getText();
                    this.notifyCallbacks(text);
                }, this.debounceDelay);
            }

            handleKeydown(event) {
                // Handle Tab key for indentation
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const start = this.textarea.selectionStart;
                    const end = this.textarea.selectionEnd;
                    const text = this.textarea.value;

                    // Insert tab or spaces
                    const tabChar = '    '; // 4 spaces
                    this.textarea.value = text.substring(0, start) + tabChar + text.substring(end);
                    this.textarea.selectionStart = this.textarea.selectionEnd = start + tabChar.length;

                    this.handleInput();
                }
            }

            onInput(callback) {
                if (typeof callback === 'function') {
                    this.callbacks.push(callback);
                }
            }

            notifyCallbacks(text) {
                this.callbacks.forEach(callback => {
                    try {
                        callback(text);
                    } catch (error) {
                        console.error('Error in editor callback:', error);
                    }
                });
            }

            getText() {
                return this.textarea.value || '';
            }

            setText(text) {
                if (typeof text === 'string') {
                    this.textarea.value = text;
                    this.handleInput();
                }
            }

            // Get cursor position for advanced features
            getCursorPosition() {
                return {
                    start: this.textarea.selectionStart,
                    end: this.textarea.selectionEnd
                };
            }

            // Set cursor position
            setCursorPosition(start, end = start) {
                this.textarea.selectionStart = start;
                this.textarea.selectionEnd = end;
                this.textarea.focus();
            }

            // Insert text at cursor position
            insertText(text) {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const currentText = this.textarea.value;

                this.textarea.value = currentText.substring(0, start) + text + currentText.substring(end);
                this.setCursorPosition(start + text.length);
                this.handleInput();
            }

            // Focus the editor
            focus() {
                this.textarea.focus();
            }

            // Clear the editor
            clear() {
                this.setText('');
            }

            // Get text statistics
            getStats() {
                const text = this.getText();
                return {
                    characters: text.length,
                    charactersNoSpaces: text.replace(/\s/g, '').length,
                    words: text.trim() ? text.trim().split(/\s+/).length : 0,
                    lines: text.split('\n').length,
                    paragraphs: text.split(/\n\s*\n/).filter(p => p.trim()).length
                };
            }
        }

        // Initialize application
        console.log('JAMdown Pad initialized');

        // Basic marked.js availability check
        if (typeof marked === 'undefined') {
            console.error('marked.js failed to load');
            document.getElementById('preview').innerHTML = '<p style="color: red;">Error: Markdown parser failed to load. Please refresh the page.</p>';
        } else {
            console.log('marked.js loaded successfully');

            // Test the normalization engine
            NormalizationEngine.test();

            // Preview Controller - Manages HTML rendering using marked.js
            class PreviewController {
                constructor(previewElement) {
                    this.previewElement = previewElement;
                    this.currentHTML = '';
                    this.isProcessing = false;

                    this.setupMarkedOptions();
                }

                setupMarkedOptions() {
                    // Configure marked.js options for better rendering
                    if (typeof marked !== 'undefined' && marked.setOptions) {
                        marked.setOptions({
                            breaks: true, // Convert \n to <br>
                            gfm: true, // GitHub Flavored Markdown
                            headerIds: false, // Don't add IDs to headers
                            mangle: false, // Don't mangle email addresses
                            sanitize: false, // Allow HTML (marked.js has built-in XSS protection)
                        });
                    }
                }

                render(markdownText) {
                    if (this.isProcessing) {
                        return;
                    }

                    try {
                        this.isProcessing = true;

                        // Handle empty input
                        if (!markdownText || typeof markdownText !== 'string') {
                            this.currentHTML = '';
                            this.updatePreview('');
                            return;
                        }

                        // Convert markdown to HTML using marked.js
                        let html = '';
                        if (typeof marked !== 'undefined') {
                            if (typeof marked.parse === 'function') {
                                // marked v4+ syntax
                                html = marked.parse(markdownText);
                            } else if (typeof marked === 'function') {
                                // marked v3 and earlier syntax
                                html = marked(markdownText);
                            } else {
                                throw new Error('marked.js API not recognized');
                            }
                        } else {
                            throw new Error('marked.js not available');
                        }

                        this.currentHTML = html;
                        this.updatePreview(html);

                    } catch (error) {
                        console.error('Error rendering markdown:', error);
                        this.handleRenderError(error, markdownText);
                    } finally {
                        this.isProcessing = false;
                    }
                }

                updatePreview(html) {
                    if (this.previewElement) {
                        this.previewElement.innerHTML = html;

                        // Scroll to top if content changed significantly
                        if (this.previewElement.scrollTop > 0 && html.length < 100) {
                            this.previewElement.scrollTop = 0;
                        }
                    }
                }

                handleRenderError(error, markdownText) {
                    const errorMessage = `
                        <div style="color: #dc3545; padding: 1rem; border: 1px solid #dc3545; border-radius: 4px; background: #f8d7da;">
                            <h4>Rendering Error</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>Input length:</strong> ${markdownText ? markdownText.length : 0} characters</p>
                            <p>Please check your markdown syntax or try refreshing the page.</p>
                        </div>
                    `;
                    this.updatePreview(errorMessage);
                }

                getHTML() {
                    return this.currentHTML;
                }

                // Get plain text content (for statistics)
                getPlainText() {
                    if (this.previewElement) {
                        return this.previewElement.textContent || this.previewElement.innerText || '';
                    }
                    return '';
                }

                // Clear the preview
                clear() {
                    this.currentHTML = '';
                    this.updatePreview('');
                }

                // Check if marked.js is available and working
                static isMarkedAvailable() {
                    try {
                        if (typeof marked === 'undefined') {
                            return false;
                        }

                        // Test basic functionality
                        const testMarkdown = '# Test';
                        let result = '';

                        if (typeof marked.parse === 'function') {
                            result = marked.parse(testMarkdown);
                        } else if (typeof marked === 'function') {
                            result = marked(testMarkdown);
                        } else {
                            return false;
                        }

                        return result.includes('<h1>') && result.includes('Test');
                    } catch (error) {
                        console.error('marked.js availability test failed:', error);
                        return false;
                    }
                }
            }

            // Initialize editor controller
            const editorElement = document.getElementById('editor');
            const previewElement = document.getElementById('preview');

            if (editorElement && previewElement) {
                const editorController = new EditorController(editorElement);
                const previewController = new PreviewController(previewElement);

                console.log('EditorController initialized');
                console.log('PreviewController initialized');

                // Test preview controller
                if (PreviewController.isMarkedAvailable()) {
                    console.log('marked.js is working correctly');

                    // Connect editor to preview with normalization
                    editorController.onInput((text) => {
                        // Normalize Japanese notation to standard Markdown
                        const normalizedText = NormalizationEngine.normalize(text);

                        // Render the normalized markdown
                        previewController.render(normalizedText);
                    });

                    // Initial render with placeholder content
                    const initialText = editorController.getText();
                    if (initialText) {
                        const normalizedText = NormalizationEngine.normalize(initialText);
                        previewController.render(normalizedText);
                    }

                } else {
                    console.error('marked.js is not working correctly');
                    previewController.handleRenderError(new Error('marked.js not available'), '');
                }

                // File Handler - Manages file upload and processing
                class FileHandler {
                    constructor(fileInputElement) {
                        console.log('FileHandler constructor called with:', fileInputElement);
                        this.fileInput = fileInputElement;
                        this.callbacks = [];
                        this.maxFileSize = 5 * 1024 * 1024; // 5MB limit
                        this.supportedExtensions = ['.md', '.jamd', '.jmd', '.txt'];

                        if (this.fileInput) {
                            this.setupEventListeners();
                            console.log('FileHandler initialized successfully');
                        } else {
                            console.error('FileHandler: fileInputElement is null or undefined');
                        }
                    }

                    setupEventListeners() {
                        this.fileInput.addEventListener('change', (event) => {
                            this.handleFileSelection(event);
                        });
                    }

                    async handleFileSelection(event) {
                        const files = event.target.files;
                        if (!files || files.length === 0) {
                            return;
                        }

                        const file = files[0];

                        try {
                            // Validate file
                            this.validateFile(file);

                            // Read file content
                            const content = await this.readFile(file);

                            // Create file data object
                            const fileData = {
                                name: file.name,
                                content: content,
                                type: this.getFileType(file.name),
                                size: file.size,
                                lastModified: new Date(file.lastModified)
                            };

                            // Notify callbacks
                            this.notifyCallbacks(fileData);

                        } catch (error) {
                            console.error('File processing error:', error);
                            this.handleFileError(error, file);
                        } finally {
                            // Clear the file input to allow re-selecting the same file
                            this.fileInput.value = '';
                        }
                    }

                    validateFile(file) {
                        // Check file size
                        if (file.size > this.maxFileSize) {
                            throw new Error(`File size (${this.formatFileSize(file.size)}) exceeds the maximum limit of ${this.formatFileSize(this.maxFileSize)}`);
                        }

                        // Check file extension
                        const extension = this.getFileExtension(file.name);
                        if (!this.supportedExtensions.includes(extension)) {
                            throw new Error(`File type "${extension}" is not supported. Supported types: ${this.supportedExtensions.join(', ')}`);
                        }

                        // Check if file is empty
                        if (file.size === 0) {
                            throw new Error('File is empty');
                        }
                    }

                    readFile(file) {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();

                            reader.onload = (event) => {
                                try {
                                    const content = event.target.result;
                                    if (typeof content === 'string') {
                                        resolve(content);
                                    } else {
                                        reject(new Error('Failed to read file as text'));
                                    }
                                } catch (error) {
                                    reject(error);
                                }
                            };

                            reader.onerror = () => {
                                reject(new Error('Failed to read file'));
                            };

                            reader.onabort = () => {
                                reject(new Error('File reading was aborted'));
                            };

                            // Read as text with UTF-8 encoding
                            reader.readAsText(file, 'UTF-8');
                        });
                    }

                    getFileExtension(filename) {
                        const lastDot = filename.lastIndexOf('.');
                        return lastDot !== -1 ? filename.substring(lastDot).toLowerCase() : '';
                    }

                    getFileType(filename) {
                        const extension = this.getFileExtension(filename);
                        switch (extension) {
                            case '.jamd':
                                return 'jamd';
                            case '.jmd':
                                return 'jmd';
                            case '.md':
                                return 'md';
                            case '.txt':
                                return 'txt';
                            default:
                                return 'unknown';
                        }
                    }

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    }

                    onFileSelected(callback) {
                        if (typeof callback === 'function') {
                            this.callbacks.push(callback);
                        }
                    }

                    notifyCallbacks(fileData) {
                        this.callbacks.forEach(callback => {
                            try {
                                callback(fileData);
                            } catch (error) {
                                console.error('Error in file callback:', error);
                            }
                        });
                    }

                    handleFileError(error, file) {
                        const errorMessage = `File Error: ${error.message}`;
                        console.error(errorMessage, file);

                        // Show user-friendly error message
                        alert(errorMessage);
                    }

                    // Trigger file selection dialog
                    selectFile() {
                        console.log('selectFile() called');
                        if (this.fileInput) {
                            console.log('File input exists, triggering click');
                            this.fileInput.click();
                        } else {
                            console.error('File input element not found');
                        }
                    }

                    // Get supported file types for display
                    getSupportedTypes() {
                        return [...this.supportedExtensions];
                    }

                    // Set maximum file size
                    setMaxFileSize(bytes) {
                        this.maxFileSize = bytes;
                    }
                }

                // Note: File handling is now managed by the main JAMdownApp class

                // Export Manager - Handles file downloads and clipboard operations
                class ExportManager {
                    constructor() {
                        this.isClipboardSupported = this.checkClipboardSupport();
                    }

                    checkClipboardSupport() {
                        return navigator.clipboard &&
                            typeof navigator.clipboard.writeText === 'function' &&
                            window.isSecureContext;
                    }

                    downloadFile(content, filename, fileType = 'md') {
                        try {
                            // Generate filename if not provided
                            if (!filename) {
                                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                                filename = `jamdown-${timestamp}`;
                            }

                            // Remove existing extension if present
                            filename = filename.replace(/\.(md|jamd|jmd)$/i, '');

                            // Add appropriate extension
                            filename += `.${fileType}`;

                            // Determine MIME type
                            let mimeType = 'text/plain;charset=utf-8';
                            switch (fileType) {
                                case 'md':
                                    mimeType = 'text/markdown;charset=utf-8';
                                    break;
                                case 'jamd':
                                case 'jmd':
                                    mimeType = 'text/plain;charset=utf-8';
                                    break;
                            }

                            // Create blob with UTF-8 encoding
                            const blob = new Blob([content], { type: mimeType });

                            // Create download link (only once)
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            link.style.display = 'none'; // Hide the link

                            // Trigger download
                            document.body.appendChild(link);
                            link.click();

                            // Clean up immediately
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);

                            console.log(`Downloaded: ${filename} (${this.formatFileSize(blob.size)})`);
                            return true;

                        } catch (error) {
                            console.error('Download error:', error);
                            this.showError('Failed to download file: ' + error.message);
                            return false;
                        }
                    }

                    // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÅÆ„É¨„Ç¨„Ç∑„Éº„É°„ÇΩ„ÉÉ„Éâ
                    downloadAsMarkdown(content, filename = null) {
                        return this.downloadFile(content, filename, 'md');
                    }

                    // JAMD„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÊó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅ„Åó„ÅüÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºâ
                    downloadAsJAMD(content, filename = null) {
                        return this.downloadFile(content, filename, 'jamd');
                    }

                    // JMD„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÊó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅ„Åó„ÅüÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºâ
                    downloadAsJMD(content, filename = null) {
                        return this.downloadFile(content, filename, 'jmd');
                    }

                    async copyHTMLToClipboard(html) {
                        try {
                            if (this.isClipboardSupported) {
                                // Use modern Clipboard API
                                await navigator.clipboard.writeText(html);
                                console.log('HTML copied to clipboard using Clipboard API');
                                return true;
                            } else {
                                // Fallback method
                                return this.fallbackCopyToClipboard(html);
                            }
                        } catch (error) {
                            console.error('Clipboard error:', error);

                            // Try fallback method
                            try {
                                return this.fallbackCopyToClipboard(html);
                            } catch (fallbackError) {
                                console.error('Fallback clipboard error:', fallbackError);
                                this.showError('Failed to copy to clipboard. Please copy manually.');
                                return false;
                            }
                        }
                    }

                    fallbackCopyToClipboard(text) {
                        try {
                            // Create temporary textarea
                            const textarea = document.createElement('textarea');
                            textarea.value = text;
                            textarea.style.position = 'fixed';
                            textarea.style.left = '-9999px';
                            textarea.style.top = '-9999px';

                            document.body.appendChild(textarea);
                            textarea.focus();
                            textarea.select();

                            // Try to copy using execCommand
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textarea);

                            if (successful) {
                                console.log('HTML copied to clipboard using fallback method');
                                return true;
                            } else {
                                throw new Error('execCommand copy failed');
                            }
                        } catch (error) {
                            throw new Error('Fallback copy method failed: ' + error.message);
                        }
                    }

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    }

                    showError(message) {
                        // Simple error display - could be enhanced with better UI
                        alert(message);
                    }

                    showSuccess(message) {
                        // Simple success display - could be enhanced with better UI
                        console.log('Success:', message);
                    }

                    // Generate filename from content (extract title if available)
                    generateFilename(content) {
                        try {
                            // Look for first heading as filename
                            const lines = content.split('\n');
                            for (let line of lines) {
                                const trimmed = line.trim();
                                if (trimmed.startsWith('#')) {
                                    // Extract heading text
                                    let title = trimmed.replace(/^#+\s*/, '').trim();
                                    // Clean filename
                                    title = title.replace(/[<>:"/\\|?*]/g, '').substring(0, 50);
                                    if (title) {
                                        return title + '.md';
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('Error generating filename from content:', error);
                        }

                        // Fallback to timestamp
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                        return `jamdown-${timestamp}.md`;
                    }

                    // Export both markdown and HTML
                    async exportBoth(markdownContent, htmlContent) {
                        const results = {
                            markdown: false,
                            html: false
                        };

                        // Download markdown
                        const filename = this.generateFilename(markdownContent);
                        results.markdown = this.downloadAsMarkdown(markdownContent, filename);

                        // Copy HTML to clipboard
                        results.html = await this.copyHTMLToClipboard(htmlContent);

                        return results;
                    }
                }

                // Note: Export functionality is now handled by the main JAMdownApp class

                // Main Application Class - Coordinates all components
                class JAMdownApp {
                    constructor() {
                        this.components = {};
                        this.isInitialized = false;
                        this.errorCount = 0;

                        this.init();
                    }

                    async init() {
                        try {
                            console.log('Initializing JAMdown Pad...');

                            // Check prerequisites
                            this.checkPrerequisites();

                            // Initialize components
                            await this.initializeComponents();

                            // Setup global error handling
                            this.setupErrorHandling();

                            // Connect components
                            this.connectComponents();

                            // Setup keyboard shortcuts
                            this.setupKeyboardShortcuts();

                            // Initial render
                            this.performInitialRender();

                            this.isInitialized = true;
                            console.log('JAMdown Pad initialized successfully');

                            // Show welcome message if editor is empty
                            this.showWelcomeIfEmpty();

                        } catch (error) {
                            console.error('Failed to initialize JAMdown Pad:', error);
                            this.handleInitializationError(error);
                        }
                    }

                    checkPrerequisites() {
                        // Check marked.js availability
                        if (!PreviewController.isMarkedAvailable()) {
                            throw new Error('marked.js library is not available or not working correctly');
                        }

                        // Check required DOM elements
                        const requiredElements = ['editor', 'preview', 'file-input', 'upload-btn', 'download-md-btn', 'copy-html-btn'];
                        for (let id of requiredElements) {
                            if (!document.getElementById(id)) {
                                throw new Error(`Required element not found: ${id}`);
                            }
                        }
                    }

                    async initializeComponents() {
                        // Initialize editor controller
                        const editorElement = document.getElementById('editor');
                        this.components.editor = new EditorController(editorElement);

                        // Initialize preview controller
                        const previewElement = document.getElementById('preview');
                        this.components.preview = new PreviewController(previewElement);

                        // Initialize file handler
                        const fileInputElement = document.getElementById('file-input');
                        this.components.fileHandler = new FileHandler(fileInputElement);

                        // Initialize export manager
                        this.components.exportManager = new ExportManager();

                        console.log('All components initialized');
                    }

                    connectComponents() {
                        // Connect editor to preview with normalization
                        this.components.editor.onInput((text) => {
                            try {
                                const normalizedText = NormalizationEngine.normalize(text);
                                this.components.preview.render(normalizedText);
                            } catch (error) {
                                console.error('Error in editor-preview pipeline:', error);
                                this.handleComponentError('editor-preview', error);
                            }
                        });

                        // Connect file handler to editor
                        this.components.fileHandler.onFileSelected((fileData) => {
                            try {
                                this.components.editor.setText(fileData.content);
                                this.showFileLoadedMessage(fileData);

                                // Show file type specific message
                                let typeMessage = '';
                                switch (fileData.type) {
                                    case 'jamd':
                                        typeMessage = 'JAMD„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü - Êó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅ';
                                        break;
                                    case 'jmd':
                                        typeMessage = 'JMD„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü - Êó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅ';
                                        break;
                                    case 'md':
                                        typeMessage = 'Markdown„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü - Ê®ôÊ∫ñË®òÊ≥ï';
                                        break;
                                    case 'txt':
                                        typeMessage = '„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü';
                                        break;
                                    default:
                                        typeMessage = '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü';
                                }
                                console.log(typeMessage);

                            } catch (error) {
                                console.error('Error loading file into editor:', error);
                                this.handleComponentError('file-loading', error);
                            }
                        });

                        // Connect upload button
                        const uploadButton = document.getElementById('upload-btn');
                        if (uploadButton) {
                            uploadButton.addEventListener('click', () => {
                                console.log('Upload button clicked');
                                if (this.components.fileHandler) {
                                    console.log('FileHandler exists, calling selectFile()');
                                    this.components.fileHandler.selectFile();
                                } else {
                                    console.error('FileHandler not initialized');
                                }
                            });
                            console.log('Upload button event listener attached');
                        } else {
                            console.error('Upload button not found');
                        }

                        // Connect download buttons
                        const downloadMdButton = document.getElementById('download-md-btn');
                        const downloadJamdButton = document.getElementById('download-jamd-btn');
                        const downloadJmdButton = document.getElementById('download-jmd-btn');

                        downloadMdButton.addEventListener('click', () => {
                            this.handleDownload('md');
                        });

                        downloadJamdButton.addEventListener('click', () => {
                            this.handleDownload('jamd');
                        });

                        downloadJmdButton.addEventListener('click', () => {
                            this.handleDownload('jmd');
                        });

                        // Connect copy HTML button
                        const copyHtmlButton = document.getElementById('copy-html-btn');
                        copyHtmlButton.addEventListener('click', () => {
                            this.handleCopyHTML();
                        });

                        console.log('Components connected');
                    }

                    setupErrorHandling() {
                        // Global error handler
                        window.addEventListener('error', (event) => {
                            this.handleGlobalError(event.error, 'Global Error');
                        });

                        // Unhandled promise rejection handler
                        window.addEventListener('unhandledrejection', (event) => {
                            this.handleGlobalError(event.reason, 'Unhandled Promise Rejection');
                        });
                    }

                    setupKeyboardShortcuts() {
                        document.addEventListener('keydown', (event) => {
                            // Ctrl/Cmd + S: Download as .md
                            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                                event.preventDefault();
                                this.handleDownload('md');
                            }

                            // Ctrl/Cmd + Shift + C: Copy HTML
                            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'C') {
                                event.preventDefault();
                                this.handleCopyHTML();
                            }

                            // Ctrl/Cmd + O: Open file
                            if ((event.ctrlKey || event.metaKey) && event.key === 'o') {
                                event.preventDefault();
                                this.components.fileHandler.selectFile();
                            }
                        });
                    }

                    performInitialRender() {
                        const initialText = this.components.editor.getText();
                        if (initialText.trim()) {
                            const normalizedText = NormalizationEngine.normalize(initialText);
                            this.components.preview.render(normalizedText);
                        }
                    }

                    showWelcomeIfEmpty() {
                        const currentText = this.components.editor.getText();
                        if (!currentText.trim()) {
                            const welcomeText = `# JAMdown Pad „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ üéå

JAMdown Pad „ÅØÊó•Êú¨Ë™û„ÅÆÂÖ®ËßíÊñáÂ≠ó„Å®Ê®ôÊ∫ñÁöÑ„Å™ÂçäËßíÊñáÂ≠ó„ÅÆ‰∏°Êñπ„Çí‰Ωø„Å£„Å¶„ÄÅ„Ç∑„Éº„É†„É¨„Çπ„Å´Markdown„ÇíÊõ∏„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

## ‰ª•‰∏ã„ÅÆ‰æã„ÇíË©¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºö

### Êó•Êú¨Ë™ûË®òÊ≥ïÔºàÂÖ®ËßíÔºâ:
ÔºÉ Ë¶ãÂá∫„Åó
ÔºäÔºäÂ§™Â≠óÔºäÔºä
ÔºäÊñú‰ΩìÔºä
Ôºû ÂºïÁî®Êñá
„Éª „É™„Çπ„ÉàÈ†ÖÁõÆ
ÔºëÔºé Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà
„Äå„É™„É≥„ÇØ„ÄçÔºàhttps://example.comÔºâ

ÔΩúÂàóÔºëÔΩúÂàóÔºíÔΩúÂàóÔºìÔΩú
ÔΩúÔºö„ÉºÔΩúÔºö„ÉºÔºöÔΩú„ÉºÔºöÔΩú
ÔΩúÂ∑¶ÂØÑ„ÅõÔΩú‰∏≠Â§ÆÔΩúÂè≥ÂØÑ„ÅõÔΩú
ÔΩú„Éá„Éº„ÇøÔºëÔΩú„Éá„Éº„ÇøÔºíÔΩú„Éá„Éº„ÇøÔºìÔΩú

ÔΩÄ„Ç§„É≥„É©„Ç§„É≥„Ç≥„Éº„ÉâÔΩÄ
„Äú„ÄúÂèñ„ÇäÊ∂à„ÅóÁ∑ö„Äú„Äú
‚ñ° Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ
‚òë ÂÆå‰∫Ü„Çø„Çπ„ÇØ
ÔºÅ„ÄåÁîªÂÉèË™¨Êòé„ÄçÔºàimage.jpgÔºâ
ËÑöÊ≥®„ÅÆÂèÇÁÖßÔºªÔºæÔºëÔºΩ

### Ê®ôÊ∫ñË®òÊ≥ïÔºàÂçäËßíÔºâ:
# Ë¶ãÂá∫„Åó
**Â§™Â≠ó**
*Êñú‰Ωì*
> ÂºïÁî®
* „É™„Çπ„ÉàÈ†ÖÁõÆ
1. Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà
[„É™„É≥„ÇØ](https://example.com)

| Âàó1 | Âàó2 | Âàó3 |
|:--------|:-------:|--------:|
| Â∑¶ÂØÑ„Åõ | ‰∏≠Â§Æ | Âè≥ÂØÑ„Åõ |
| „Éá„Éº„Çø1 | „Éá„Éº„Çø2 | „Éá„Éº„Çø3 |

\`„Ç§„É≥„É©„Ç§„É≥„Ç≥„Éº„Éâ\`
~~Âèñ„ÇäÊ∂à„ÅóÁ∑ö~~
- [ ] Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ
- [x] ÂÆå‰∫Ü„Çø„Çπ„ÇØ
![ÁîªÂÉèË™¨Êòé](image.jpg)
ËÑöÊ≥®ÂèÇÁÖß[^1]

### Ê∑∑Âú®Ë®òÊ≥ï„ÇÇ‰Ωø„Åà„Åæ„ÅôÔºÅ
ÔºÉ Êó•Êú¨Ë™ûË¶ãÂá∫„Åó
**Ëã±Ë™ûÂ§™Â≠ó** „Å® ÔºäÔºäÊó•Êú¨Ë™ûÂ§™Â≠óÔºäÔºä
„Éª Ê∑∑Âú®„É™„Çπ„Éà with *Ëã±Ë™ûÊñú‰Ωì*

---

**„Éï„Ç°„Ç§„É´ÂΩ¢Âºè:**
- **.md**: Ê®ôÊ∫ñ„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥ÔºàÊó•Êú¨Ë™ûË®òÊ≥ï„ÇíÂçäËßí„Å´Â§âÊèõÔºâ
- **.jamd**: Êó•Êú¨Ë™û„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥ÔºàÂÖ®ËßíË®òÊ≥ï„Çí‰øùÊåÅÔºâ
- **.jmd**: Êó•Êú¨Ë™û„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÅÆÁü≠Á∏ÆÂΩ¢ÔºàÂÖ®ËßíË®òÊ≥ï„Çí‰øùÊåÅÔºâ

**„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà:**
- Ctrl/Cmd + S: .md„Éï„Ç°„Ç§„É´‰øùÂ≠ò
- Ctrl/Cmd + Shift + C: HTML„Ç≥„Éî„Éº
- Ctrl/Cmd + O: „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè

ÂÖ•Âäõ„ÇíÂßã„ÇÅ„Å¶È≠îÊ≥ï„Çí‰ΩìÈ®ì„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ ‚ú®`;

                            this.components.editor.setText(welcomeText);
                        }
                    }

                    handleDownload(fileType = 'md') {
                        try {
                            const currentText = this.components.editor.getText();
                            if (!currentText.trim()) {
                                alert('„Ç®„Éá„Ç£„Çø„ÅåÁ©∫„Åß„Åô„ÄÇ„Åæ„ÅöÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                                return;
                            }

                            let content, filename, buttonId, buttonText;

                            switch (fileType) {
                                case 'md':
                                    // .md„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÄÅÊ≠£Ë¶èÂåñ„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩøÁî®ÔºàÊ®ôÊ∫ñMarkdownÔºâ
                                    content = NormalizationEngine.normalize(currentText);
                                    filename = this.components.exportManager.generateFilename(content);
                                    buttonId = 'download-md-btn';
                                    buttonText = '.md‰øùÂ≠ò';
                                    break;

                                case 'jamd':
                                    // .jamd„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÄÅÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩøÁî®ÔºàÊó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅÔºâ
                                    content = currentText;
                                    filename = this.components.exportManager.generateFilename(content);
                                    buttonId = 'download-jamd-btn';
                                    buttonText = '.jamd‰øùÂ≠ò';
                                    break;

                                case 'jmd':
                                    // .jmd„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÄÅÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩøÁî®ÔºàÊó•Êú¨Ë™ûË®òÊ≥ï„Çí‰øùÊåÅÔºâ
                                    content = currentText;
                                    filename = this.components.exportManager.generateFilename(content);
                                    buttonId = 'download-jmd-btn';
                                    buttonText = '.jmd‰øùÂ≠ò';
                                    break;

                                default:
                                    throw new Error(`Unsupported file type: ${fileType}`);
                            }

                            const success = this.components.exportManager.downloadFile(content, filename, fileType);

                            if (success) {
                                this.showButtonSuccess(buttonId, '‚úì Downloaded', buttonText);
                            }
                        } catch (error) {
                            console.error('Download error:', error);
                            this.handleComponentError('download', error);
                        }
                    }

                    async handleCopyHTML() {
                        try {
                            const currentHTML = this.components.preview.getHTML();
                            if (!currentHTML.trim()) {
                                alert('„Éó„É¨„Éì„É•„Éº„ÅåÁ©∫„Åß„Åô„ÄÇ„Åæ„ÅöÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                                return;
                            }

                            const success = await this.components.exportManager.copyHTMLToClipboard(currentHTML);

                            if (success) {
                                this.showButtonSuccess('copy-html-btn', '‚úì „Ç≥„Éî„ÉºÂÆå‰∫Ü', 'HTML„Ç≥„Éî„Éº');
                            }
                        } catch (error) {
                            console.error('Copy HTML error:', error);
                            this.handleComponentError('copy-html', error);
                        }
                    }

                    showButtonSuccess(buttonId, successText, originalText) {
                        const button = document.getElementById(buttonId);
                        if (button) {
                            button.textContent = successText;
                            button.style.background = 'var(--success-bg)';
                            button.style.borderColor = 'var(--success-border)';
                            button.style.color = 'var(--success-text)';

                            setTimeout(() => {
                                button.textContent = originalText;
                                button.style.background = '';
                                button.style.borderColor = '';
                                button.style.color = '';
                            }, 2000);
                        }
                    }

                    showFileLoadedMessage(fileData) {
                        const uploadButton = document.getElementById('upload-btn');
                        if (uploadButton) {
                            const message = `‚úì ${fileData.name}`;
                            uploadButton.textContent = message;
                            uploadButton.style.background = 'var(--success-bg)';
                            uploadButton.style.borderColor = 'var(--success-border)';
                            uploadButton.style.color = 'var(--success-text)';

                            setTimeout(() => {
                                uploadButton.textContent = '„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè';
                                uploadButton.style.background = '';
                                uploadButton.style.borderColor = '';
                                uploadButton.style.color = '';
                            }, 3000);
                        }
                    }

                    handleComponentError(component, error) {
                        this.errorCount++;
                        console.error(`Component error (${component}):`, error);

                        // Show user-friendly error message
                        const message = `Error in ${component}: ${error.message}`;
                        alert(message);
                    }

                    handleGlobalError(error, type) {
                        this.errorCount++;
                        console.error(`${type}:`, error);

                        // Don't show alert for every global error to avoid spam
                        if (this.errorCount <= 3) {
                            console.warn('Global error occurred. Check console for details.');
                        }
                    }

                    handleInitializationError(error) {
                        const errorMessage = `
                            <div style="color: #dc3545; padding: 2rem; text-align: center; font-family: Arial, sans-serif;">
                                <h2>JAMdown Pad Failed to Initialize</h2>
                                <p><strong>Error:</strong> ${error.message}</p>
                                <p>Please refresh the page or check your browser console for more details.</p>
                            </div>
                        `;

                        const previewElement = document.getElementById('preview');
                        if (previewElement) {
                            previewElement.innerHTML = errorMessage;
                        }
                    }

                    // Public API methods
                    getEditor() {
                        return this.components.editor;
                    }

                    getPreview() {
                        return this.components.preview;
                    }

                    getExportManager() {
                        return this.components.exportManager;
                    }

                    isReady() {
                        return this.isInitialized;
                    }
                }

                // Theme Management
                class ThemeManager {
                    constructor() {
                        this.theme = localStorage.getItem('theme') || 'light';
                        this.init();
                    }

                    init() {
                        // Apply saved theme
                        this.applyTheme(this.theme);

                        // Setup theme toggle button
                        const themeToggle = document.getElementById('theme-toggle');
                        if (themeToggle) {
                            themeToggle.addEventListener('click', () => {
                                this.toggleTheme();
                            });
                        }

                        // Listen for system theme changes
                        if (window.matchMedia) {
                            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                            mediaQuery.addListener(() => {
                                if (!localStorage.getItem('theme')) {
                                    this.applySystemTheme();
                                }
                            });
                        }
                    }

                    toggleTheme() {
                        this.theme = this.theme === 'light' ? 'dark' : 'light';
                        this.applyTheme(this.theme);
                        localStorage.setItem('theme', this.theme);
                    }

                    applyTheme(theme) {
                        document.documentElement.setAttribute('data-theme', theme);
                        this.updateThemeIcon(theme);
                    }

                    applySystemTheme() {
                        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                        this.theme = prefersDark ? 'dark' : 'light';
                        this.applyTheme(this.theme);
                    }

                    updateThemeIcon(theme) {
                        const sunIcon = document.querySelector('.sun-icon');
                        const moonIcon = document.querySelector('.moon-icon');

                        if (sunIcon && moonIcon) {
                            if (theme === 'dark') {
                                sunIcon.style.display = 'none';
                                moonIcon.style.display = 'block';
                            } else {
                                sunIcon.style.display = 'block';
                                moonIcon.style.display = 'none';
                            }
                        }
                    }
                }

                // Initialize theme manager
                const themeManager = new ThemeManager();

                // Initialize the main application
                const app = new JAMdownApp();

                // Make app globally available for debugging
                window.JAMdownApp = app;
                window.ThemeManager = themeManager;

            } else {
                console.error('Editor or preview element not found');
            }
        }
    </script>
</body>

</html>